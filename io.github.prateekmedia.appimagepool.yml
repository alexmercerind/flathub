app-id: io.github.prateekmedia.appimagepool
runtime: org.gnome.Platform
runtime-version: "40"
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
rename-icon: appimagepool
rename-appdata-file: appimagepool.appdata.xml
rename-desktop-file: appimagepool.desktop
command: appimagepool
separate-locales: false
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --share=network
  - --device=dri
  - --filesystem=~/Applications:create
  - --talk-name=org.freedesktop.Notifications
build-options:
  append-path: /usr/lib/sdk/rust-stable/bin:/app/lib/sdk/flutter/bin
  env:
    CARGO_HOME: /run/build/appimagepool/cargo
modules:
  - name: flutter
    buildsystem: simple
    cleanup: ["*"]
    sources:
      - type: archive
        url: https://storage.googleapis.com/flutter_infra_release/releases/beta/linux/flutter_linux_2.6.0-5.2.pre-beta.tar.xz
        sha256: 1a2d82b9a7934d00d680b6a0a9e09697264dd86ba37d984812c73297f33458e2
    build-commands:
      - install -d /app/lib/sdk/flutter
      - cp -rpv * .git /app/lib/sdk/flutter/
      - flutter config --enable-linux-desktop

  - name: appimagepool
    buildsystem: simple
    build-commands:
      - cargo --offline build --release --verbose
      - cp -aR target/release/data/ /app/appimagepool/data/
      - cp -aR target/release/lib/ /app/appimagepool/lib/
      - install -Dm744 target/release/appimagepool /app/appimagepool/appimagepool
      - install -Dm644  assets/appimagepool.svg /app/share/icons/hicolor/128x128/apps/appimagepool.svg
      - install -Dm644  assets/appimagepool.desktop /app/share/applications/appimagepool.desktop
      - install -Dm644  assets/appimagepool.appdata.xml /app/share/metainfo/appimagepool.appdata.xml
      - sed -i 's/<id>appimagepool/<id>io.github.prateekmedia.appimagepool/' /app/share/metainfo/appimagepool.appdata.xml
      - mkdir -p /app/bin/ /app/lib/
      - ln -s /usr/lib/${FLATPAK_ARCH}-linux-gnu/libgio-2.0.so.0 /app/lib/libgio-2.0.so
      - ln -s /app/appimagepool/appimagepool /app/bin/appimagepool
    sources:
      - type: git
        url: https://github.com/prateekmedia/appimagepool.git
        tag: 2.4.1
        commit: 37bca61abd50b72eff058ab80ebe5e1d8f2a2d64
      - generated-sources.json
